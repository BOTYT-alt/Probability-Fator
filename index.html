<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="google-adsense-account" content="ca-pub-8590335598454899">
  <title>ProbabilityFactor</title>
  <style>
    :root {
      --bg-light: #f3f7fb;
      --bg-dark: #0b1020;
      --panel-light: rgba(255,255,255,0.6);
      --panel-dark: rgba(255,255,255,0.04);
      --text-light: #0b1020;
      --text-dark: #e6f6ff;
      --accent: #00eaff;
      --accent-2: #6a00ff;
      --glass: rgba(255,255,255,0.06);
      --border-glow: 0 6px 30px rgba(0,234,255,0.08);
    }

    /* Base */
    * { box-sizing: border-box; }
    html,body { height:100%; }
    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, system-ui, -apple-system, 'Helvetica Neue', Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(0,234,255,0.06), transparent),
                  linear-gradient(180deg,#fbfdff 0%, #f3f7fb 100%);
      color: var(--text-light);
      transition: background 0.35s ease, color 0.35s ease;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    body.dark {
      background: radial-gradient(900px 500px at 80% 10%, rgba(106,0,255,0.08), transparent),
                  linear-gradient(180deg,#07080a 0%, #0b1020 100%);
      color: var(--text-dark);
    }

    /* Layout */
    .app {
      display:flex;
      min-height:100vh;
      overflow:hidden;
      position:relative;
    }

    /* Collapsible sidebar */
    .sidebar {
      width:260px;
      min-width:60px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-right: 1px solid rgba(255,255,255,0.03);
      padding:1.2rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
      transition: transform 0.38s cubic-bezier(.2,.9,.2,1), width 0.35s ease, background 0.35s ease;
      z-index: 30;
    }
    body.dark .sidebar { background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); }
    .sidebar.collapsed { width:72px; }

    .brand {
      display:flex;align-items:center;gap:0.75rem;
      padding: 0.3rem 0.2rem;
    }
    .logo {
      width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#001; font-weight:700; box-shadow:var(--border-glow);
      transform: translateZ(0);
    }
    .brand h3 { margin:0;font-size:1rem;letter-spacing:0.2px; }

    .nav {
      display:flex;flex-direction:column;gap:0.3rem;margin-top:0.6rem;
    }
    .nav button {
      background: transparent;border: none;color:inherit;padding:0.6rem 0.4rem;cursor:pointer;border-radius:8px;
      display:flex;align-items:center;gap:0.8rem;font-weight:600;transition:background 0.2s, transform 0.18s;
    }
    .nav button:hover{ background: linear-gradient(90deg, rgba(0,234,255,0.06), rgba(106,0,255,0.04)); transform: translateX(4px); }

    .hamburger {
      position: absolute; left: 14px; top:14px; background:transparent;border:none;color:inherit;padding:8px;cursor:pointer;
      width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;z-index:60;
      transition: transform .25s ease;
    }
    .hamburger .lines { width:22px;height:14px;position:relative; }
    .hamburger .lines span{ position:absolute;left:0;right:0;height:2px;background:currentColor;border-radius:2px;transition:transform .28s ease,opacity .2s ease; }
    .hamburger .lines span:nth-child(1){ top:0; }
    .hamburger .lines span:nth-child(2){ top:6px; }
    .hamburger .lines span:nth-child(3){ top:12px; }
    .hamburger.open .lines span:nth-child(1){ transform: translateY(6px) rotate(45deg); }
    .hamburger.open .lines span:nth-child(2){ opacity:0; }
    .hamburger.open .lines span:nth-child(3){ transform: translateY(-6px) rotate(-45deg); }

    /* Main content */
    .main {
      flex:1;display:flex;gap:1.2rem;padding:2.2rem;align-items:stretch;justify-content:center;transition:padding .3s ease;
    }

    .panel {
      flex:1;min-width:280px;background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.28));
      border-radius:14px;padding:1.6rem;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0.6rem;
      box-shadow: var(--border-glow);
      border: 1px solid rgba(0,0,0,0.04);
      transition: transform 0.28s ease, box-shadow 0.28s ease, background 0.35s ease;
      position:relative;overflow:hidden;
    }
    body.dark .panel{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03); }
    .panel:hover{ transform: translateY(-6px); }

    h1 { margin:0;font-size:1.3rem; }

    /* coin */
    .coin-wrap { perspective: 1000px; margin:12px 0; }
    .coin {
      width:140px;height:140px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;color:#022;
      background: conic-gradient(from 90deg, #00eaff, #6a00ff);
      box-shadow: 0 10px 30px rgba(0,0,0,0.12), 0 0 40px rgba(0,234,255,0.06) inset;
      transform-style: preserve-3d;transition: transform .9s cubic-bezier(.2,.9,.2,1);
      position:relative;color:white;letter-spacing:1px;
    }
    .coin.face-head { background: linear-gradient(135deg,#00eaff,#007a99); }
    .coin.face-tail { background: linear-gradient(135deg,#6a00ff,#2a0066); }

    .coin::after{
      content:'';position:absolute;inset:6px;border-radius:50%;box-shadow:inset 0 2px 12px rgba(255,255,255,0.06);
    }

    /* flip animation */
    .flip { animation: coinFlip .9s cubic-bezier(.2,.9,.2,1); }
    @keyframes coinFlip {
      0% { transform: rotateY(0) translateZ(0); }
      25% { transform: rotateY(180deg) translateZ(40px) translateY(-10px); }
      50% { transform: rotateY(360deg) translateZ(0) translateY(0); }
      75% { transform: rotateY(540deg) translateZ(40px) translateY(-10px); }
      100% { transform: rotateY(720deg) translateZ(0); }
    }

    /* buttons */
    .btn { padding:0.7rem 1.1rem;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#042;font-weight:800;cursor:pointer;box-shadow:0 6px 20px rgba(0,234,255,0.06);transition:transform .18s ease,opacity .18s; }
    .btn:active{ transform: translateY(2px); }
    .ghost { background: transparent;border:1px solid rgba(255,255,255,0.06); color:inherit; }

    /* save animation */
    .saved-pulse { animation: savedPulse 1.2s ease both; }
    @keyframes savedPulse { 0%{ transform: scale(1) } 50%{ transform: scale(1.06) } 100%{ transform: scale(1); } }

    /* toast */
    .toast{ position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#021;padding:12px 18px;border-radius:10px;box-shadow:var(--border-glow);display:none;z-index:120; }

    /* score bar */
    .score { width:220px;margin-top:10px;text-align:center; }
    .progress { width:100%;height:12px;background:rgba(0,0,0,0.06);border-radius:999px;overflow:hidden; }
    .progress > i { display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent-2));width:0%;transition:width .6s cubic-bezier(.2,.9,.2,1); }

    /* goal input */
    textarea { width:100%;min-height:120px;border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.06);resize:vertical;background:transparent;color:inherit;font-size:0.98rem; }

    /* How-to modal */
    .modal-backdrop{ position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;z-index:80;padding:20px; }
    .modal{ width:min(880px,96%);max-height:86vh;overflow:auto;background:linear-gradient(180deg,#fff,#f7fbff);padding:1.6rem;border-radius:12px;box-shadow:0 18px 50px rgba(0,0,0,0.35); }
    body.dark .modal{ background: linear-gradient(180deg,#071225,#071225); color:var(--text-dark); }
    .modal h2{ margin-top:0; }
    .modal .steps{ display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px; }
    .step { padding:12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0.6)); }

    /* Donation / About imagery */
    .hero-illustration{ width:100%;max-height:220px;border-radius:10px;overflow:hidden;margin-bottom:12px; }
    .hero-illustration svg{ width:100%;height:100%;display:block; }

    /* Saved goals slide panel */
    .saved-panel { position:fixed;right:-420px;top:0;height:100vh;width:380px;background:linear-gradient(180deg,#fff,#f6fbff);box-shadow:-20px 0 60px rgba(0,0,0,0.2);z-index:85;padding:18px;transition:right .36s cubic-bezier(.2,.9,.2,1);overflow:auto; }
    .saved-panel.open { right:0; }
    .goal-list { list-style:none;padding:0;margin:12px 0; }
    .goal-item { padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(0,0,0,0.03);display:flex;align-items:center;justify-content:space-between; }
    .goal-item.active{ outline:2px solid rgba(0,234,255,0.12); box-shadow:0 6px 18px rgba(0,234,255,0.04); }

    .meta { font-size:0.82rem; opacity:0.78; }

    /* small helpers */
    .muted{ opacity:0.7;font-size:0.95rem; }

    /* Responsive */
    @media (max-width:900px){
      .sidebar{ position:fixed;left:0;top:0;height:100vh;transform:translateX(-100%); }
      .sidebar.open{ transform:translateX(0); }
      .hamburger{ left:12px; top:12px; }
      .main{ padding:1rem; }
      .saved-panel{ width:100%; right:-100%; }
      .saved-panel.open{ right:0; }
      .app{ padding-top:56px; }
      .panel{ padding:1rem; }
    }

    @media (max-width:600px){
      .main{ flex-direction:column;padding:1rem; }
      .coin{ width:120px;height:120px;font-size:16px; }
      .score{ width:160px; }
    }

  </style>
</head>
<body>
  <div class="hamburger" id="hamburger" aria-label="Toggle menu">
    <div class="lines"><span></span><span></span><span></span></div>
  </div>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">PF</div>
        <div>
          <h3>ProbabilityFactor</h3>
          <div class="muted" style="font-size:0.78rem;">Make decisions with a playful nudge</div>
        </div>
      </div>

      <nav class="nav">
        <button id="openHowTo">How To Use</button>
        <button id="openSaved">Saved Goals</button>
        <button id="openDonate">Donate</button>
        <button id="openAbout">About</button>
        <button id="toggleThemeBtn">🌙 Toggle Theme</button>
      </nav>

      <div style="margin-top:auto;font-size:0.82rem;opacity:0.8;">v1.2 • Local-only</div>
    </aside>

    <main class="main">
      <section class="panel left">
        <h1>🎲 Probability Factor</h1>
        <div class="muted">Toss the coin to gauge your chances for the selected goal</div>

        <div class="coin-wrap">
          <div class="coin face-head" id="coin">HEAD</div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
          <button class="btn" id="tossBtn" disabled>Toss Coin</button>
          <button class="btn ghost" id="resetBtn">Reset</button>
        </div>

        <div class="score">
          <div class="muted">Confidence</div>
          <div class="progress" aria-hidden>
            <i id="progressFill"></i>
          </div>
          <div id="scoreText" class="muted">--%</div>
        </div>
      </section>

      <section class="panel right">
        <h1>📝 Your Goal</h1>
        <div class="muted" id="activeHint">No active goal selected</div>

        <textarea id="goalInput" placeholder="Write your goal here..."></textarea>
        <div style="display:flex;gap:10px;margin-top:10px;width:100%;justify-content:flex-end;">
          <button class="btn ghost" id="previewBtn">Preview</button>
          <button class="btn" id="saveGoalBtn">Save Goal</button>
        </div>

        <div style="margin-top:12px;width:100%;display:flex;justify-content:space-between;align-items:center;">
          <div class="meta">Active Goal: <span id="activeTitle">—</span></div>
          <div>
            <button class="btn ghost" id="exportBtn">Export Goals</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- How To Modal -->
  <div class="modal-backdrop" id="howBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="howTitle">
      <h2 id="howTitle">How to Use ProbabilityFactor</h2>
      <p>ProbabilityFactor helps you reflect on goals by giving a playful probability nudge. Save a goal, select it, then toss once to get a confidence score.</p>
      <div class="steps">
        <div class="step"><strong>1.</strong> Write a clear goal in the right panel.</div>
        <div class="step"><strong>2.</strong> Save it (it will animate and become active).</div>
        <div class="step"><strong>3.</strong> Press "Toss Coin" — each saved goal can be tossed only once (you can add multiple goals).</div>
        <div class="step"><strong>4.</strong> Review the saved goals and history in the Saved Goals panel.</div>
      </div>
      <hr />
      <h3>Tips</h3>
      <ul>
        <li>Make goals actionable and time-boxed (e.g., "Run 3x per week for a month").</li>
        <li>Use toss results to trigger reflection and next steps, not as absolute truth.</li>
        <li>Export or delete goals as you progress.</li>
      </ul>
      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
        <button class="btn ghost" id="closeHow">Close</button>
      </div>
    </div>
  </div>

  <!-- Donation Modal -->
  <div class="modal-backdrop" id="donateBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="donateTitle">
      <h2 id="donateTitle">Support Good Causes</h2>
      <div class="hero-illustration">
        <!-- Simple inline SVG illustration -->
        <svg viewBox="0 0 800 200" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none">
          <defs>
            <linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#00eaff"/><stop offset="1" stop-color="#6a00ff"/></linearGradient>
          </defs>
          <rect width="800" height="200" fill="#f6fbff"/>
          <g transform="translate(40,20)">
            <circle cx="80" cy="80" r="48" fill="url(#g1)" opacity="0.95" />
            <text x="160" y="95" font-family="Segoe UI" font-size="20" fill="#072">Donate to local charities or global organizations to amplify impact.</text>
          </g>
        </svg>
      </div>
      <p>We encourage supporting verified charities. Here are some options to consider:</p>
      <ul>
        <li><strong>Local food banks</strong> — support your nearby community.</li>
        <li><strong>Education funds</strong> — donate to programs that teach coding and skills.</li>
        <li><strong>Climate & environment</strong> — support conservation groups.</li>
      </ul>
      <p>You can also <a href="mailto:hello@probabilityfactor.example?subject=Donation%20Info">contact us</a> for curated charity partners.</p>
      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
        <button class="btn ghost" id="closeDonate">Close</button>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal-backdrop" id="aboutBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
      <h2 id="aboutTitle">About ProbabilityFactor</h2>
      <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
        <div style="width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#012;font-weight:800;">PF</div>
        <div>
          <div><strong>ProbabilityFactor</strong> was created by the makers behind <em>mariosocial</em>.</div>
          <div class="meta">Creator: Ayak Marial — social: <a href="https://twitter.com/ayakthechad" target="_blank">@ayakthechad</a></div>
        </div>
      </div>
      <p style="margin-top:12px;">This app is a playful decision-support tool. It stores data locally. No tracking. Use tosses to reflect and iterate on goals.</p>
      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
        <button class="btn ghost" id="closeAbout">Close</button>
      </div>
    </div>
  </div>

  <!-- Saved Goals Slide Panel -->
  <aside class="saved-panel" id="savedPanel" aria-hidden="true">
    <h3>Your Saved Goals</h3>
    <div class="muted">All data is stored locally in your browser.</div>
    <ul class="goal-list" id="goalList"></ul>
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:space-between;align-items:center;">
      <div class="muted">History</div>
      <div>
        <button class="btn ghost" id="clearAll">Clear All</button>
        <button class="btn ghost" id="closeSaved">Close</button>
      </div>
    </div>
    <div style="margin-top:12px;font-size:0.92rem;opacity:0.85;" id="historyLog"></div>
  </aside>

  <div class="toast" id="toast">Goal saved — now toss the coin!</div>

  <script>
    // Elements
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const openHowTo = document.getElementById('openHowTo');
    const howBackdrop = document.getElementById('howBackdrop');
    const closeHow = document.getElementById('closeHow');
    const openSaved = document.getElementById('openSaved');
    const savedPanel = document.getElementById('savedPanel');
    const closeSaved = document.getElementById('closeSaved');
    const tossBtn = document.getElementById('tossBtn');
    const resetBtn = document.getElementById('resetBtn');
    const coin = document.getElementById('coin');
    const progressFill = document.getElementById('progressFill');
    const scoreText = document.getElementById('scoreText');
    const saveGoalBtn = document.getElementById('saveGoalBtn');
    const goalInput = document.getElementById('goalInput');
    const goalListEl = document.getElementById('goalList');
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    const previewBtn = document.getElementById('previewBtn');
    const toast = document.getElementById('toast');
    const activeTitle = document.getElementById('activeTitle');
    const activeHint = document.getElementById('activeHint');
    const exportBtn = document.getElementById('exportBtn');
    const openDonate = document.getElementById('openDonate');
    const donateBackdrop = document.getElementById('donateBackdrop');
    const closeDonate = document.getElementById('closeDonate');
    const openAbout = document.getElementById('openAbout');
    const aboutBackdrop = document.getElementById('aboutBackdrop');
    const closeAbout = document.getElementById('closeAbout');
    const clearAllBtn = document.getElementById('clearAll');
    const historyLog = document.getElementById('historyLog');

    // State
    let goals = JSON.parse(localStorage.getItem('savedGoals') || '[]');
    let history = JSON.parse(localStorage.getItem('tossHistory') || '[]');
    // Normalize old-style string goals to objects
    goals = goals.map(g => (typeof g === 'string') ? { id: Date.now()+Math.random(), text: g, createdAt: Date.now(), tossed:false, score:null } : g);
    let activeGoalId = goals.length ? goals[0].id : null;

    // Helpers
    function persistGoals(){ localStorage.setItem('savedGoals', JSON.stringify(goals)); }
    function persistHistory(){ localStorage.setItem('tossHistory', JSON.stringify(history)); }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function showToast(msg, t=2200){ toast.textContent = msg; toast.style.display='block'; toast.style.opacity = 1; setTimeout(()=>{ toast.style.opacity=0; setTimeout(()=>{ toast.style.display='none'; }, 300); }, t); }

    // Render saved goals
    function renderGoals(){
      goalListEl.innerHTML = '';
      if(goals.length === 0){
        goalListEl.innerHTML = '<li class="muted">No saved goals yet.</li>';
      }
      goals.forEach((g, idx) =>{
        const li = document.createElement('li'); li.className='goal-item';
        if(g.id === activeGoalId) li.classList.add('active');
        const left = document.createElement('div'); left.style.flex='1'; left.style.paddingRight='8px';
        left.innerHTML = `<div style="font-weight:700">${escapeHtml(g.text)}</div><div class="meta">${new Date(g.createdAt).toLocaleString()} • ${g.tossed ? 'Tossed' : 'Ready' }${g.score!==null?(' • '+g.score+'%'):''}</div>`;
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
        const sel = document.createElement('button'); sel.className='btn ghost'; sel.textContent = (g.id===activeGoalId)?'Active':'Select';
        sel.onclick = ()=>{ activeGoalId = g.id; updateActiveUI(); renderGoals(); savedPanel.classList.remove('open'); };
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
        del.onclick = ()=>{ if(confirm('Delete this goal?')){ goals.splice(idx,1); if(activeGoalId===g.id) activeGoalId = goals.length?goals[0].id:null; persistGoals(); renderGoals(); updateActiveUI(); } };
        actions.appendChild(sel); actions.appendChild(del);
        li.appendChild(left); li.appendChild(actions);
        goalListEl.appendChild(li);
      });
      renderHistory();
    }

    function renderHistory(){
      if(history.length===0){ historyLog.innerHTML = '<div class="muted">No toss history yet.</div>'; return; }
      const items = history.slice().reverse().slice(0,8).map(h => `<div style="padding:8px;border-radius:8px;background:rgba(0,0,0,0.03);margin-bottom:8px;"><strong>${escapeHtml(h.goalText)}</strong><div class="meta">${new Date(h.at).toLocaleString()} • ${h.result} • ${h.score}%</div></div>`).join('');
      historyLog.innerHTML = items;
    }

    function updateActiveUI(){
      const active = goals.find(g=>g.id===activeGoalId);
      if(active){
        activeTitle.textContent = active.text.length>40?active.text.slice(0,40)+'...':active.text;
        activeHint.textContent = active.tossed?`Tossed • Score: ${active.score}%`:'Saved and ready — toss once.';
        tossBtn.disabled = active.tossed;
        tossBtn.style.opacity = active.tossed?0.5:1;
      } else {
        activeTitle.textContent = '—';
        activeHint.textContent = 'No active goal selected';
        tossBtn.disabled = true; tossBtn.style.opacity=0.6;
      }
    }

    // Hamburger toggles sidebar
    hamburger.addEventListener('click', ()=>{
      const open = hamburger.classList.toggle('open');
      if(window.innerWidth <= 900){
        sidebar.classList.toggle('open', open);
      } else {
        sidebar.classList.toggle('collapsed', open);
      }
    });

    // Theme toggle - with icon update
    function setTheme(dark){ document.body.classList.toggle('dark', dark); toggleThemeBtn.textContent = dark? '☀️ Light' : '🌙 Dark'; localStorage.setItem('pf_theme_dark', dark? '1' : '0'); }
    const savedTheme = localStorage.getItem('pf_theme_dark'); if(savedTheme==='1') setTheme(true);
    toggleThemeBtn.addEventListener('click', ()=>{ setTheme(!document.body.classList.contains('dark')); });

    // HowTo modal
    openHowTo.addEventListener('click', ()=>{ howBackdrop.style.display='flex'; });
    closeHow.addEventListener('click', ()=>{ howBackdrop.style.display='none'; });
    howBackdrop.addEventListener('click', (e)=>{ if(e.target===howBackdrop) howBackdrop.style.display='none'; });

    // Donate modal
    openDonate.addEventListener('click', ()=>{ donateBackdrop.style.display='flex'; });
    closeDonate.addEventListener('click', ()=>{ donateBackdrop.style.display='none'; });
    donateBackdrop.addEventListener('click', (e)=>{ if(e.target===donateBackdrop) donateBackdrop.style.display='none'; });

    // About modal
    openAbout.addEventListener('click', ()=>{ aboutBackdrop.style.display='flex'; });
    closeAbout.addEventListener('click', ()=>{ aboutBackdrop.style.display='none'; });
    aboutBackdrop.addEventListener('click', (e)=>{ if(e.target===aboutBackdrop) aboutBackdrop.style.display='none'; });

    // Saved panel
    openSaved.addEventListener('click', ()=>{ savedPanel.classList.add('open'); renderGoals(); });
    closeSaved.addEventListener('click', ()=>{ savedPanel.classList.remove('open'); });

    // Save goal - store as object and make active
    saveGoalBtn.addEventListener('click', ()=>{
      const text = goalInput.value.trim();
      if(!text) return alert('Please write a goal before saving.');
      const obj = { id: Date.now()+Math.random(), text, createdAt: Date.now(), tossed:false, score:null };
      goals.unshift(obj);
      persistGoals(); renderGoals(); goalInput.value='';
      // visual pulse and toast
      saveGoalBtn.classList.add('saved-pulse');
      setTimeout(()=> saveGoalBtn.classList.remove('saved-pulse'), 1200);
      activeGoalId = obj.id; updateActiveUI();
      showToast('Goal saved — now toss the coin!');
    });

    // Export goals
    exportBtn.addEventListener('click', ()=>{
      const data = { goals, history };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'pf-goals.json'; a.click(); URL.revokeObjectURL(url);
    });

    // Clear all
    clearAllBtn.addEventListener('click', ()=>{
      if(!confirm('Clear all goals and history?')) return;
      goals = []; history = []; persistGoals(); persistHistory(); renderGoals(); updateActiveUI();
    });

    // Reset UI
    resetBtn.addEventListener('click', ()=>{
      progressFill.style.width='0%'; scoreText.textContent='--%'; coin.textContent='HEAD'; coin.className='coin face-head';
    });

    // Toss logic - one toss per goal
    tossBtn.addEventListener('click', ()=>{
      const active = goals.find(g=>g.id===activeGoalId);
      if(!active){ alert('Select or save a goal first.'); return; }
      if(active.tossed){ alert('This goal has already been tossed. Select another goal.'); return; }

      // Visual flip
      coin.classList.remove('face-head','face-tail');
      coin.classList.add('flip');

      const r = Math.random();
      const chance = Math.min(98, Math.max(2, Math.round((r*100 + (goals.length>0?12:0))*100)/100));
      const result = (Math.random() < 0.78) ? 'HEAD' : 'TAIL';

      setTimeout(()=>{
        coin.classList.remove('flip');
        coin.classList.add(result==='HEAD' ? 'face-head' : 'face-tail');
        coin.textContent = result;
      }, 820);

      setTimeout(()=>{
        progressFill.style.width = chance + '%';
        scoreText.textContent = chance + '%';
        active.tossed = true; active.score = chance; persistGoals();
        history.push({ goalId: active.id, goalText: active.text, result, score: chance, at: Date.now() }); persistHistory();
        updateActiveUI(); renderGoals();
      }, 420);
    });

    // Preview
    previewBtn.addEventListener('click', ()=>{
      const txt = goalInput.value.trim();
      if(!txt) return alert('Write something to preview.');
      howBackdrop.style.display='flex';
      const modal = howBackdrop.querySelector('.modal');
      const preview = document.createElement('div'); preview.style.marginTop='12px'; preview.innerHTML=`<strong>Preview:</strong><div style="padding:8px;background:rgba(0,0,0,0.03);border-radius:6px;margin-top:8px">${escapeHtml(txt)}</div>`;
      modal.appendChild(preview);
      setTimeout(()=>{ preview.remove(); }, 3000);
    });

    // Initial render
    renderGoals(); updateActiveUI();

    // Accessibility: close saved with ESC and modal with ESC
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        howBackdrop.style.display='none'; donateBackdrop.style.display='none'; aboutBackdrop.style.display='none'; savedPanel.classList.remove('open');
      }
    });

    // Prevent accidental submits
    goalInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)) { saveGoalBtn.click(); } });

  </script>
</body>
</html>

