<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ProbabilityFactor — a playful decision nudge</title>
  <meta name="description" content="ProbabilityFactor helps you reflect on and prioritize goals by giving a playful probability nudge. Save goals, get AI overviews, and toss a coin (Yes / No) to prompt reflection." />
  <meta name="keywords" content="probability, goals, decision, productivity, toss a coin, yes no, goal tracker" />
  <link rel="canonical" href="https://probabilityfactor.example/" />
  <meta name="robots" content="index,follow" />

  <!-- Open Graph / Twitter -->
  <meta property="og:title" content="ProbabilityFactor — a playful decision nudge" />
  <meta property="og:description" content="Save goals, get an AI overview, then toss for a Yes / No nudge and reflect on next steps." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://probabilityfactor.example/" />
  <meta property="og:image" content="https://probabilityfactor.example/og-image.png" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Structured data (JSON-LD) for SEO -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "ProbabilityFactor",
    "url": "https://probabilityfactor.example/",
    "description": "Playful decision support: save goals, get an AI overview and toss for a Yes / No nudge.",
    "applicationCategory": "Productivity",
    "operatingSystem": "Web"
  }
  </script>

  <style>
    :root{
      --bg-light:#f3f7fb;
      --bg-dark:#0b1020;
      --accent1:#00eaff;
      --accent2:#6a00ff;
      --text-dark:#0b1020;
      --text-light:#e6f6ff;
      --glass: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:Inter, 'Segoe UI', Roboto, system-ui, -apple-system, 'Helvetica Neue', Arial;-webkit-font-smoothing:antialiased}
    body{background:linear-gradient(180deg,#fbfdff,#f3f7fb);color:var(--text-dark);transition:background .3s,color .3s}
    body.dark{background:linear-gradient(180deg,#07080a,#0b1020);color:var(--text-light)}

    .app{display:flex;min-height:100vh}
    .sidebar{width:260px;padding:18px;border-right:1px solid rgba(0,0,0,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);transition:width .28s}
    .sidebar.collapsed{width:72px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#022}
    .nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
    .nav button{background:transparent;border:none;padding:8px;border-radius:8px;cursor:pointer;font-weight:700;transition:transform .18s, background .18s}
    .nav button:hover{transform:translateX(6px);background:linear-gradient(90deg,rgba(0,234,255,0.06),rgba(106,0,255,0.04))}

    .hamburger{position:fixed;left:12px;top:12px;background:transparent;border:none;color:inherit;padding:8px;width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;z-index:60}
    .lines{width:22px;height:14px;position:relative}
    .lines span{position:absolute;left:0;right:0;height:2px;background:currentColor;border-radius:2px;transition:transform .28s,opacity .2s}
    .lines span:nth-child(1){top:0}.lines span:nth-child(2){top:6px}.lines span:nth-child(3){top:12px}
    .hamburger.open .lines span:nth-child(1){transform:translateY(6px) rotate(45deg)}
    .hamburger.open .lines span:nth-child(2){opacity:0}
    .hamburger.open .lines span:nth-child(3){transform:translateY(-6px) rotate(-45deg)}

    .main{flex:1;padding:28px;display:flex;gap:18px;align-items:flex-start}
    .panel{flex:1;min-width:280px;background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(255,255,255,0.7));padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.06);transition:transform .28s}
    body.dark .panel{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04)}
    .panel:hover{transform:translateY(-6px)}

    h1{margin:0 0 8px 0;font-size:1.2rem}
    .muted{opacity:.75;font-size:0.95rem}

    /* coin */
    .coin-wrap{perspective:1000px;margin:14px 0}
    .coin{width:140px;height:140px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 10px 30px rgba(0,0,0,0.12);transform-style:preserve-3d;transition:transform .9s, box-shadow .3s}
    .coin.yes{background:linear-gradient(135deg,#00c9ff,#007a99)}
    .coin.no{background:linear-gradient(135deg,#9a6aff,#3a0070)}
    .coin::after{content:'';position:absolute;inset:6px;border-radius:50%;box-shadow:inset 0 2px 12px rgba(255,255,255,0.06)}
    @keyframes coinFlip{0%{transform:rotateY(0)}25%{transform:rotateY(180deg) translateY(-8px) translateZ(20px)}50%{transform:rotateY(360deg)}75%{transform:rotateY(540deg) translateY(-8px) translateZ(20px)}100%{transform:rotateY(720deg)}}
    .flip{animation:coinFlip .9s cubic-bezier(.2,.9,.2,1)}
    .coin-glow{position:relative}
    .coin-glow:after{content:'';position:absolute;inset:-10px;border-radius:50%;filter:blur(18px);opacity:.28;background:linear-gradient(90deg,var(--accent1),var(--accent2));z-index:-1}

    /* buttons */
    .btn{padding:.7rem 1.1rem;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#012;font-weight:800;cursor:pointer;transition:transform .12s,opacity .12s,box-shadow .12s}
    .btn:active{transform:translateY(2px)}
    .ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:inherit}

    .saved-pulse{animation:savedPulse 1.1s ease both}
    @keyframes savedPulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#021;padding:12px 18px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.18);display:none;z-index:200}

    .score{width:220px;margin-top:10px}
    .progress{width:100%;height:12px;background:rgba(0,0,0,0.06);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2));width:0%;transition:width .6s cubic-bezier(.2,.9,.2,1)}

    textarea{width:100%;min-height:120px;border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:inherit;resize:vertical}

    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:80}
    .modal{width:min(880px,96%);max-height:86vh;overflow:auto;background:linear-gradient(180deg,#fff,#f7fbff);padding:18px;border-radius:12px}
    body.dark .modal{background:linear-gradient(180deg,#071225,#071225);color:var(--text-light)}

    .saved-panel{position:fixed;right:-420px;top:0;height:100vh;width:380px;background:linear-gradient(180deg,#fff,#f6fbff);box-shadow:-20px 0 60px rgba(0,0,0,0.18);z-index:85;padding:18px;transition:right .36s}
    .saved-panel.open{right:0}
    .goal-list{list-style:none;padding:0;margin:12px 0}
    .goal-item{padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(0,0,0,0.03);display:flex;align-items:center;justify-content:space-between}
    .goal-item.active{outline:2px solid rgba(0,234,255,0.12)}
    .history-entry{padding:8px;border-radius:8px;background:rgba(0,0,0,0.03);margin-bottom:8px}

    @media(max-width:900px){
      .sidebar{position:fixed;left:0;top:0;height:100vh;transform:translateX(-100%);transition:transform .28s}
      .sidebar.open{transform:translateX(0)}
      .hamburger{left:12px;top:12px}
      .main{padding:16px}
      .saved-panel{width:100%;right:-100%}.saved-panel.open{right:0}
    }
  </style>
</head>
<body>
  <button class="hamburger" id="hamburger" aria-label="Toggle menu" aria-expanded="false">
    <div class="lines"><span></span><span></span><span></span></div>
  </button>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="logo">PF</div>
        <div>
          <h3>ProbabilityFactor</h3>
          <div class="muted" style="font-size:.78rem">Make decisions with a playful nudge</div>
        </div>
      </div>

      <nav class="nav" role="navigation" aria-label="Main">
        <button id="openHowTo">How To Use</button>
        <button id="openSaved">Saved Goals</button>
        <button id="openDonate">Donate</button>
        <button id="openAbout">About</button>
        <button id="toggleThemeBtn">🌙 Dark</button>
        <button id="previewThemesBtn" class="ghost">Preview Both Themes</button>
      </nav>

      <div style="margin-top:auto;font-size:.82rem;opacity:.8">v1.3 • Local-only</div>
    </aside>

    <main class="main" id="main">
      <section class="panel left">
        <h1>🎲 Probability Factor</h1>
        <div class="muted">Toss the coin to gauge your chances for the selected goal</div>

        <div class="coin-wrap">
          <div class="coin coin-glow yes" id="coin">YES</div>
        </div>

        <div style="display:flex;gap:12px;align-items:center;margin-top:8px;">
          <button class="btn" id="tossBtn" disabled>Toss Coin</button>
          <button class="btn ghost" id="resetBtn">Reset</button>
        </div>

        <div class="score">
          <div class="muted">Confidence</div>
          <div class="progress" aria-hidden="true">
            <i id="progressFill" role="presentation"></i>
          </div>
          <div id="scoreText" class="muted">--%</div>
        </div>

      </section>

      <section class="panel right">
        <h1>📝 Your Goal</h1>
        <div class="muted" id="activeHint">No active goal selected</div>

        <textarea id="goalInput" placeholder="Write your goal here..."></textarea>
        <div style="display:flex;gap:10px;margin-top:10px;width:100%;justify-content:flex-end;">
          <button class="btn ghost" id="previewBtn">Preview</button>
          <button class="btn" id="saveGoalBtn">Save Goal</button>
        </div>

        <div style="margin-top:12px;width:100%;display:flex;justify-content:space-between;align-items:center;">
          <div class="meta">Active Goal: <span id="activeTitle">—</span></div>
          <div>
            <button class="btn ghost" id="exportBtn">Export Goals</button>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- How To Modal -->
  <div class="modal-backdrop" id="howBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="howTitle">
      <h2 id="howTitle">How to Use ProbabilityFactor</h2>
      <p>ProbabilityFactor helps you reflect on goals by giving a playful probability nudge. Save a goal, select it, then toss once to get a confidence score.</p>
      <div class="steps" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px">
        <div class="step" style="padding:12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0.6))"><strong>1.</strong> Write a clear goal in the right panel.</div>
        <div class="step" style="padding:12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0.6))"><strong>2.</strong> Save it (it will become active and request a short AI overview).</div>
        <div class="step" style="padding:12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0.6))"><strong>3.</strong> Press \"Toss Coin\" — each saved goal can be tossed only once.</div>
        <div class="step" style="padding:12px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0.6))"><strong>4.</strong> Review the saved goals and history in the Saved Goals panel.</div>
      </div>
      <hr />
      <h3>Tips</h3>
      <ul>
        <li>Make goals actionable and time-boxed (e.g., "Run 3x per week for a month").</li>
        <li>Use toss results to trigger reflection and next steps, not as absolute truth.</li>
        <li>Export or delete goals as you progress.</li>
      </ul>
      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
        <button class="btn ghost" id="closeHow">Close</button>
      </div>
    </div>
  </div>

  <!-- Donation Modal -->
  <div class="modal-backdrop" id="donateBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="donateTitle">
      <h2 id="donateTitle">Support Good Causes</h2>
      <p>We encourage supporting verified charities. Here are some options to consider:</p>
      <ul>
        <li><strong>Local food banks</strong> — support your nearby community.</li>
        <li><strong>Education funds</strong> — donate to programs that teach coding and skills.</li>
        <li><strong>Climate & environment</strong> — support conservation groups.</li>
      </ul>
      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
        <button class="btn ghost" id="closeDonate">Close</button>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal-backdrop" id="aboutBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
      <h2 id="aboutTitle">About ProbabilityFactor</h2>
      <p style="margin-top:12px;">This app is a playful decision-support tool. It stores data locally. No tracking. Use tosses to reflect and iterate on goals.</p>
      <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px;">
        <button class="btn ghost" id="closeAbout">Close</button>
      </div>
    </div>
  </div>

  <!-- Saved Goals Slide Panel -->
  <aside class="saved-panel" id="savedPanel" aria-hidden="true">
    <h3>Your Saved Goals</h3>
    <div class="muted">All data is stored locally in your browser.</div>
    <ul class="goal-list" id="goalList"></ul>
    <div style="margin-top:8px;display:flex;gap:8px;justify-content:space-between;align-items:center;">
      <div class="muted">History</div>
      <div>
        <button class="btn ghost" id="clearAll">Clear All</button>
        <button class="btn ghost" id="closeSaved">Close</button>
      </div>
    </div>
    <div style="margin-top:12px;font-size:.92rem;opacity:.85;" id="historyLog"></div>
  </aside>

  <div class="toast" id="toast">Goal saved — now toss the coin!</div>

  <script>
    // === NOTE ABOUT KEYS ===
    // You asked to use the API key; including API keys in client-side code is insecure and will expose the key publicly.
    // For production, move this call to a server endpoint and keep the secret key on the server.
    // The code below demonstrates the AI overview call inline for convenience/testing only.

    const OPENAI_KEY = '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';

    // Elements
    const hamburger = document.getElementById('hamburger');
    const sidebar = document.getElementById('sidebar');
    const openHowTo = document.getElementById('openHowTo');
    const howBackdrop = document.getElementById('howBackdrop');
    const closeHow = document.getElementById('closeHow');
    const openSaved = document.getElementById('openSaved');
    const savedPanel = document.getElementById('savedPanel');
    const closeSaved = document.getElementById('closeSaved');
    const tossBtn = document.getElementById('tossBtn');
    const resetBtn = document.getElementById('resetBtn');
    const coin = document.getElementById('coin');
    const progressFill = document.getElementById('progressFill');
    const scoreText = document.getElementById('scoreText');
    const saveGoalBtn = document.getElementById('saveGoalBtn');
    const goalInput = document.getElementById('goalInput');
    const goalListEl = document.getElementById('goalList');
    const toggleThemeBtn = document.getElementById('toggleThemeBtn');
    const previewBtn = document.getElementById('previewBtn');
    const toast = document.getElementById('toast');
    const activeTitle = document.getElementById('activeTitle');
    const activeHint = document.getElementById('activeHint');
    const exportBtn = document.getElementById('exportBtn');
    const openDonate = document.getElementById('openDonate');
    const donateBackdrop = document.getElementById('donateBackdrop');
    const closeDonate = document.getElementById('closeDonate');
    const openAbout = document.getElementById('openAbout');
    const aboutBackdrop = document.getElementById('aboutBackdrop');
    const closeAbout = document.getElementById('closeAbout');
    const clearAllBtn = document.getElementById('clearAll');
    const historyLog = document.getElementById('historyLog');
    const previewThemesBtn = document.getElementById('previewThemesBtn');

    // State
    let goals = JSON.parse(localStorage.getItem('savedGoals') || '[]');
    let history = JSON.parse(localStorage.getItem('tossHistory') || '[]');
    goals = goals.map(g => (typeof g === 'string') ? { id: Date.now()+Math.random(), text: g, createdAt: Date.now(), tossed:false, score:null, overview: '' } : g);
    let activeGoalId = goals.length ? goals[0].id : null;

    // Helpers
    function persistGoals(){ localStorage.setItem('savedGoals', JSON.stringify(goals)); }
    function persistHistory(){ localStorage.setItem('tossHistory', JSON.stringify(history)); }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function showToast(msg, t=2200){ toast.textContent = msg; toast.style.display='block'; toast.style.opacity = 1; setTimeout(()=>{ toast.style.opacity=0; setTimeout(()=>{ toast.style.display='none'; },300); }, t); }

    // Render saved goals
    function renderGoals(){
      goalListEl.innerHTML = '';
      if(goals.length === 0){
        goalListEl.innerHTML = '<li class="muted">No saved goals yet.</li>';
      }
      goals.forEach((g, idx) =>{
        const li = document.createElement('li'); li.className='goal-item';
        if(g.id === activeGoalId) li.classList.add('active');
        const left = document.createElement('div'); left.style.flex='1'; left.style.paddingRight='8px';
        const date = new Date(g.createdAt).toLocaleString();
        left.innerHTML = `<div style="font-weight:700">${escapeHtml(g.text)}</div><div class="meta">${date} • ${g.tossed ? 'Tossed' : 'Ready'}${g.score!==null?(' • '+g.score+'%'):''}</div>${g.overview?('<div style="margin-top:6px;opacity:.9;font-size:.95rem">'+escapeHtml(g.overview)+'</div>'):''}`;
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
        const sel = document.createElement('button'); sel.className='btn ghost'; sel.textContent = (g.id===activeGoalId)?'Active':'Select';
        sel.onclick = ()=>{ activeGoalId = g.id; updateActiveUI(); renderGoals(); savedPanel.classList.remove('open'); };
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';
        del.onclick = ()=>{ if(confirm('Delete this goal?')){ goals.splice(idx,1); if(activeGoalId===g.id) activeGoalId = goals.length?goals[0].id:null; persistGoals(); renderGoals(); updateActiveUI(); } };
        actions.appendChild(sel); actions.appendChild(del);
        li.appendChild(left); li.appendChild(actions);
        goalListEl.appendChild(li);
      });
      renderHistory();
    }

    function renderHistory(){
      if(history.length===0){ historyLog.innerHTML = '<div class="muted">No toss history yet.</div>'; return; }
      const items = history.slice().reverse().slice(0,8).map(h => `<div class="history-entry"><strong>${escapeHtml(h.goalText)}</strong><div class="meta">${new Date(h.at).toLocaleString()} • ${h.result} • ${h.score}%</div></div>`);
      historyLog.innerHTML = items.join('\n');
    }

    function updateActiveUI(){
      const active = goals.find(g=>g.id===activeGoalId);
      if(active){
        activeTitle.textContent = active.text.length>40?active.text.slice(0,40)+'...':active.text;
        activeHint.textContent = active.tossed?`Tossed • Score: ${active.score}%`:'Saved and ready — toss once.';
        tossBtn.disabled = active.tossed;
        tossBtn.style.opacity = active.tossed?0.5:1;
      } else {
        activeTitle.textContent = '—';
        activeHint.textContent = 'No active goal selected';
        tossBtn.disabled = true; tossBtn.style.opacity=0.6;
      }
    }

    // Hamburger toggles sidebar
    function setHamburgerOpen(open){
      hamburger.classList.toggle('open', open);
      hamburger.setAttribute('aria-expanded', String(!!open));
      if(window.innerWidth <= 900){
        sidebar.classList.toggle('open', open);
      } else {
        sidebar.classList.toggle('collapsed', open);
      }
    }
    hamburger.addEventListener('click', ()=>{
      const isOpen = hamburger.classList.toggle('open');
      setHamburgerOpen(isOpen);
    });

    // Theme toggle - with icon update
    function setTheme(dark){ document.body.classList.toggle('dark', dark); toggleThemeBtn.textContent = dark? '☀️ Light' : '🌙 Dark'; localStorage.setItem('pf_theme_dark', dark? '1' : '0'); }
    const savedTheme = localStorage.getItem('pf_theme_dark'); if(savedTheme==='1') setTheme(true);
    toggleThemeBtn.addEventListener('click', ()=>{ setTheme(!document.body.classList.contains('dark')); });

    // Preview both themes (side-by-side overlay)
    previewThemesBtn.addEventListener('click', ()=>{
      const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.inset='8%'; overlay.style.zIndex=200; overlay.style.borderRadius='12px'; overlay.style.boxShadow='0 20px 60px rgba(0,0,0,0.4)';
      overlay.style.display='grid'; overlay.style.gridTemplateColumns='1fr 1fr'; overlay.style.background='#fff';
      const left = document.createElement('div'); left.style.padding='18px'; left.style.overflow='auto'; left.style.background='linear-gradient(180deg,#fbfdff,#f3f7fb)'; left.innerHTML = document.getElementById('main').outerHTML;
      const right = document.createElement('div'); right.style.padding='18px'; right.style.overflow='auto'; right.style.background='linear-gradient(180deg,#07080a,#0b1020)'; right.innerHTML = document.getElementById('main').outerHTML;
      left.querySelectorAll('*').forEach(n=>n.style.color = 'var(--text-dark)');
      right.querySelectorAll('*').forEach(n=>n.style.color = 'var(--text-light)');
      overlay.appendChild(left); overlay.appendChild(right);
      const close = document.createElement('button'); close.textContent='Close preview'; close.className='btn'; close.style.position='absolute'; close.style.right='24px'; close.style.top='18px'; close.onclick=()=>overlay.remove();
      overlay.appendChild(close);
      document.body.appendChild(overlay);
    });

    // Modal controls
    openHowTo.addEventListener('click', ()=>{ howBackdrop.style.display='flex'; });
    closeHow.addEventListener('click', ()=>{ howBackdrop.style.display='none'; });
    howBackdrop.addEventListener('click', (e)=>{ if(e.target===howBackdrop) howBackdrop.style.display='none'; });

    openDonate.addEventListener('click', ()=>{ donateBackdrop.style.display='flex'; });
    closeDonate.addEventListener('click', ()=>{ donateBackdrop.style.display='none'; });
    donateBackdrop.addEventListener('click', (e)=>{ if(e.target===donateBackdrop) donateBackdrop.style.display='none'; });

    openAbout.addEventListener('click', ()=>{ aboutBackdrop.style.display='flex'; });
    closeAbout.addEventListener('click', ()=>{ aboutBackdrop.style.display='none'; });
    aboutBackdrop.addEventListener('click', (e)=>{ if(e.target===aboutBackdrop) aboutBackdrop.style.display='none'; });

    // Saved panel
    openSaved.addEventListener('click', ()=>{ savedPanel.classList.add('open'); renderGoals(); });
    closeSaved.addEventListener('click', ()=>{ savedPanel.classList.remove('open'); });

    // Save goal - store as object, make active, request short AI overview
    saveGoalBtn.addEventListener('click', async ()=>{
      const text = goalInput.value.trim();
      if(!text) return alert('Please write a goal before saving.');
      const obj = { id: Date.now()+Math.random(), text, createdAt: Date.now(), tossed:false, score:null, overview: 'Generating overview...' };
      goals.unshift(obj);
      persistGoals(); renderGoals(); goalInput.value='';
      saveGoalBtn.classList.add('saved-pulse'); setTimeout(()=> saveGoalBtn.classList.remove('saved-pulse'), 1200);
      activeGoalId = obj.id; updateActiveUI();
      showToast('Goal saved — generating overview...');

      // Client-side AI overview request (insecure on public sites). Prefer server-side endpoint.
      try {
        const system = `You are a helpful assistant. Provide a concise 1-2 sentence overview of the goal and two practical suggestions, in plain text.`;
        const user = `Goal: ${text}\n\nRespond in the format: Overview: <one or two sentences>. Suggestions: 1) ...; 2) ...`;
        const payload = {
          model: "gpt-3.5-turbo",
          messages: [
            { role: "system", content: system },
            { role: "user", content: user }
          ],
          temperature: 0.6,
          max_tokens: 220
        };
        const resp = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + OPENAI_KEY
          },
          body: JSON.stringify(payload)
        });
        if(!resp.ok) throw new Error('AI request failed: ' + resp.status);
        const data = await resp.json();
        const txt = (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) ? data.choices[0].message.content.trim() : null;
        const overview = txt || 'Overview unavailable.';
        // Update the saved goal
        const idx = goals.findIndex(g=>g.id===obj.id);
        if(idx !== -1){
          goals[idx].overview = overview;
          persistGoals();
          renderGoals();
        }
        showToast('Overview generated');
      } catch(err) {
        // Fallback: gracefully set overview and inform user.
        const idx = goals.findIndex(g=>g.id===obj.id);
        if(idx !== -1){
          goals[idx].overview = 'Overview unavailable (AI call failed).';
          persistGoals();
          renderGoals();
        }
        console.warn('AI overview error', err);
        showToast('Overview unavailable', 2000);
      }
    });

    // Export goals
    exportBtn.addEventListener('click', ()=>{
      const data = { goals, history };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'pf-goals.json'; a.click(); URL.revokeObjectURL(url);
    });

    // Clear all
    clearAllBtn.addEventListener('click', ()=>{
      if(!confirm('Clear all goals and history?')) return;
      goals = []; history = []; persistGoals(); persistHistory(); renderGoals(); updateActiveUI();
    });

    // Reset UI
    resetBtn.addEventListener('click', ()=>{
      progressFill.style.width='0%'; scoreText.textContent='--%'; coin.textContent='YES'; coin.className='coin coin-glow yes';
    });

    // Toss logic - one toss per goal, Yes/No
    tossBtn.addEventListener('click', ()=>{
      const active = goals.find(g=>g.id===activeGoalId);
      if(!active){ alert('Select or save a goal first.'); return; }
      if(active.tossed){ alert('This goal has already been tossed. Select another goal.'); return; }

      // Visual flip
      coin.classList.remove('yes','no');
      coin.classList.add('flip');
      // Randomized chance logic, bounded
      const r = Math.random();
      const chance = Math.min(98, Math.max(2, Math.round((r*100 + (goals.length>0?12:0))*100)/100));
      const result = (Math.random() < 0.5) ? 'YES' : 'NO';

      setTimeout(()=>{
        coin.classList.remove('flip');
        coin.classList.add(result==='YES' ? 'yes' : 'no');
        coin.textContent = result;
        // subtle glow effect
        coin.style.boxShadow = result==='YES' ? '0 20px 60px rgba(0,201,255,0.12)' : '0 20px 60px rgba(106,0,255,0.10)';
      }, 520);

      setTimeout(()=>{
        progressFill.style.width = chance + '%';
        scoreText.textContent = chance + '%';
        active.tossed = true; active.score = chance; persistGoals();
        history.push({ goalId: active.id, goalText: active.text, result, score: chance, at: Date.now() }); persistHistory();
        updateActiveUI(); renderGoals();
        showToast(`Result: ${result} • ${chance}%`, 2200);
      }, 740);
    });

    // Preview
    previewBtn.addEventListener('click', ()=>{
      const txt = goalInput.value.trim();
      if(!txt) return alert('Write something to preview.');
      howBackdrop.style.display='flex';
      const modal = howBackdrop.querySelector('.modal');
      const preview = document.createElement('div'); preview.style.marginTop='12px'; preview.innerHTML=`<strong>Preview:</strong><div style="padding:8px;background:rgba(0,0,0,0.03);border-radius:6px;margin-top:6px">${escapeHtml(txt)}</div>`;
      modal.appendChild(preview);
      setTimeout(()=>{ preview.remove(); }, 3000);
    });

    // Initial render
    renderGoals(); updateActiveUI();

    // Accessibility: close saved with ESC and modal with ESC
    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape'){
        howBackdrop.style.display='none'; donateBackdrop.style.display='none'; aboutBackdrop.style.display='none'; savedPanel.classList.remove('open');
        setHamburgerOpen(false);
      }
    });

    // Prevent accidental submits
    goalInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)) { saveGoalBtn.click(); } });

    // Small UX: if window resizes, ensure sidebar state is consistent
    window.addEventListener('resize', ()=>{
      if(window.innerWidth > 900){
        sidebar.classList.remove('open');
      } else {
        sidebar.classList.remove('collapsed');
      }
    });
  </script>
</body>
</html>
